<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yibo.modules.base.dao.DeptDao">
    <!-- 在这里存放用户自定义的映射配置（注：DeptDAO.xml里各节点的ID不能在这里重复出现）  -->
    <!-- 查询树结构数据 -->
    <select id="findTree" resultType="com.yibo.modules.base.entity.Dept">
        select
            id, parent_id, ancestor_id, dept_name, dept_type, dept_sort, dept_level from sys_dept
        <where>
            and status = 1
            and tenant_id = #{tenantId,jdbcType=VARCHAR}
        </where>
        order by ancestor_id, dept_sort
    </select>

    <!-- 调用存储过程更新父级ID -->
    <select id="updateAncestor" parameterType="com.yibo.modules.base.entity.Dept" statementType="CALLABLE" resultType="java.util.Map">
	    {call sp_deal_dept_ancestor(#{id,jdbcType=VARCHAR,mode=IN})}
    </select>

    <!-- 唯一性校验 -->
    <select id="count" resultType="java.lang.Integer">
        select count(1) from sys_dept
        <where>
            <if test="condition.id != null and condition.id.length() > 0">
                and id not in(select #{condition.id})
            </if>
            and dept_name = #{condition.deptName,jdbcType=VARCHAR}
            and tenant_id = #{condition.tenantId,jdbcType=VARCHAR}
            and status = 1
        </where>
    </select>

    <!-- 级联删除 -->
    <update id="deleteCascade">
        <foreach collection="list" item="id">
            update sys_dept set status = 0 where ancestor_id like concat('%', #{id} , '%');
        </foreach>
    </update>
</mapper>